import React from 'react';

// --- Helper Functions ---

/**
 * Calculates attendance details for a given subject.
 * @param {object} subject - The subject object.
 * @param {string} semesterStartDate - The start date of the semester in 'YYYY-MM-DD' format.
 * @returns {object} An object containing total, attended, and percentage.
 */
const calculateAttendance = (subject, semesterStartDate) => {
  // Return zeros if there's no schedule or start date to avoid errors
  if (!subject.schedule || subject.schedule.length === 0 || !semesterStartDate) {
    return { total: 0, attended: 0, percentage: 0 };
  }

  // Map day names to numerical values (0-6)
  const dayMap = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
  const scheduledDays = subject.schedule.map(day => dayMap.indexOf(day));

  let totalClasses = 0;
  const today = new Date();
  const startDate = new Date(semesterStartDate);

  // Iterate from the start date to today to count scheduled classes
  let currentDate = new Date(startDate);
  while (currentDate <= today) {
    const dayOfWeek = currentDate.getDay();
    if (scheduledDays.includes(dayOfWeek)) {
      const dateString = currentDate.toISOString().split('T')[0];
      // Only count if it wasn't a canceled class
      if (!subject.cancelledDates.includes(dateString)) {
        totalClasses++;
      }
    }
    // Increment the date by one day
    currentDate.setDate(currentDate.getDate() + 1);
  }

  const missedCount = subject.missedDates.length;
  const attendedClasses = totalClasses - missedCount;
  const percentage = totalClasses > 0 ? ((attendedClasses / totalClasses) * 100) : 0;

  return {
    total: totalClasses,
    attended: attendedClasses,
    percentage: parseFloat(percentage.toFixed(2)),
  };
};

// --- Main App Component ---

const App = () => {
  // --- State Management ---
  const [subjects, setSubjects] = React.useState([]);
  const [semesterStartDate, setSemesterStartDate] = React.useState('');
  const [newSubjectName, setNewSubjectName] = React.useState('');
  const [newSubjectSchedule, setNewSubjectSchedule] = React.useState([]);
  const [selectedSubject, setSelectedSubject] = React.useState(null);
  const [isLoading, setIsLoading] = React.useState(true);
  const [modalMessage, setModalMessage] = React.useState(null);
  const [confirmModal, setConfirmModal] = React.useState(null);

  const ATTENDANCE_GOAL = 75;
  const DAYS_OF_WEEK = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

  // --- Effects for Local Storage Persistence ---

  // Load data from localStorage on initial render
  React.useEffect(() => {
    try {
      const savedSubjects = localStorage.getItem('attendanceAppSubjects');
      const savedStartDate = localStorage.getItem('attendanceAppStartDate');
      if (savedSubjects) {
        setSubjects(JSON.parse(savedSubjects));
      }
      if (savedStartDate) {
        setSemesterStartDate(savedStartDate);
      }
    } catch (error) {
      console.error("Failed to load data from local storage:", error);
      setModalMessage("Error: Failed to load data from local storage.");
    } finally {
      setIsLoading(false);
    }
  }, []);

  // Save data to localStorage whenever subjects or start date change
  React.useEffect(() => {
    try {
      localStorage.setItem('attendanceAppSubjects', JSON.stringify(subjects));
      localStorage.setItem('attendanceAppStartDate', semesterStartDate);
    } catch (error) {
      console.error("Failed to save data to local storage:", error);
      // No need to show a modal here, as it would be annoying for the user
    }
  }, [subjects, semesterStartDate]);

  // --- Core Functions ---

  /**
   * Adds a new subject to the list after validation.
   */
  const addSubject = () => {
    if (newSubjectName.trim() === '' || newSubjectSchedule.length === 0) {
      setModalMessage("Please enter a subject name and select at least one day for the schedule.");
      return;
    }
    const newSubject = {
      id: Date.now().toString(),
      name: newSubjectName.trim(),
      schedule: newSubjectSchedule,
      missedDates: [],
      cancelledDates: [],
    };
    setSubjects([...subjects, newSubject]);
    setNewSubjectName('');
    setNewSubjectSchedule([]);
  };

  /**
   * Deletes a subject after user confirmation.
   * @param {string} subjectId - The ID of the subject to delete.
   */
  const deleteSubject = (subjectId) => {
    setConfirmModal({
      message: "Are you sure you want to delete this subject and all its records?",
      onConfirm: () => {
        setSubjects(subjects.filter(s => s.id !== subjectId));
        if (selectedSubject && selectedSubject.id === subjectId) {
          setSelectedSubject(null);
        }
        setConfirmModal(null);
      },
      onCancel: () => setConfirmModal(null)
    });
  };

  /**
   * Toggles a day in the new subject's schedule.
   * @param {string} day - The day of the week to toggle.
   */
  const handleScheduleToggle = (day) => {
    setNewSubjectSchedule(prev =>
      prev.includes(day) ? prev.filter(d => d !== day) : [...prev, day]
    );
  };

  /**
   * Updates the status of a specific date for the selected subject.
   * @param {string} dateString - The date in 'YYYY-MM-DD' format.
   * @param {string} status - The new status ('present', 'missed', or 'cancelled').
   */
  const updateDateStatus = (dateString, status) => {
    if (!selectedSubject) return;

    setSubjects(subjects.map(s => {
      if (s.id === selectedSubject.id) {
        const newSubject = { ...s };
        // Remove date from all lists first to ensure no duplicates
        newSubject.missedDates = newSubject.missedDates.filter(d => d !== dateString);
        newSubject.cancelledDates = newSubject.cancelledDates.filter(d => d !== dateString);

        // Add to the correct list if a status is set
        if (status === 'missed') {
          newSubject.missedDates.push(dateString);
        } else if (status === 'cancelled') {
          newSubject.cancelledDates.push(dateString);
        }
        
        // Update the selected subject view in real-time
        setSelectedSubject(newSubject);
        return newSubject;
      }
      return s;
    }));
  };
  
  /**
   * Handles the click on a subject card.
   * @param {object} subject The subject object.
   */
  const handleSubjectClick = (subject) => {
    setSelectedSubject(subject);
  };

  // --- Render Functions ---

  /**
   * Renders the calendar view for managing a subject's dates.
   */
  const renderDateManager = () => {
    if (!selectedSubject || !semesterStartDate) {
      return (
        <div className="text-center p-8 bg-gray-800 rounded-lg">
          <p className="text-gray-400">
            { !semesterStartDate 
              ? "Please set a semester start date to manage attendance."
              : "Select a subject to manage its attendance dates."
            }
          </p>
        </div>
      );
    }

    const today = new Date();
    const startDate = new Date(semesterStartDate);
    const dates = [];
    let currentDate = new Date(startDate);
    
    // Generate an array of all dates from start date to today
    while (currentDate <= today) {
        dates.push(new Date(currentDate));
        currentDate.setDate(currentDate.getDate() + 1);
    }

    return (
      <div className="mt-6 bg-gray-800 p-6 rounded-xl shadow-lg">
        <h3 className="text-2xl font-semibold text-gray-100 mb-4">Manage Bunks for: {selectedSubject.name}</h3>
        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-2 text-center">
          {dates.reverse().map(date => {
            const dateString = date.toISOString().split('T')[0];
            const dayOfWeek = DAYS_OF_WEEK[date.getDay()];
            const isScheduled = selectedSubject.schedule.includes(dayOfWeek);
            
            if (!isScheduled) return null; // Don't render non-scheduled days

            const isMissed = selectedSubject.missedDates.includes(dateString);
            const isCancelled = selectedSubject.cancelledDates.includes(dateString);
            const isPresent = !isMissed && !isCancelled;

            return (
              <div key={dateString} className="flex flex-col items-center p-2 bg-gray-700 rounded-lg">
                <div className="font-semibold text-sm text-gray-100">{date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                <div className="text-xs text-gray-400 mb-2">{dayOfWeek}</div>
                <div className="flex flex-col gap-1 w-full">
                   <button 
                     onClick={() => updateDateStatus(dateString, isPresent ? null : 'present')} 
                     className={`w-full text-xs py-1 rounded transition-colors ${isPresent ? 'bg-green-600 text-white font-semibold' : 'bg-gray-600 text-gray-200 hover:bg-green-500 hover:text-white'}`}>
                     âœ… Present
                   </button>
                   <button 
                     onClick={() => updateDateStatus(dateString, isMissed ? null : 'missed')} 
                     className={`w-full text-xs py-1 rounded transition-colors ${isMissed ? 'bg-red-600 text-white font-semibold' : 'bg-gray-600 text-gray-200 hover:bg-red-500 hover:text-white'}`}>
                     âŒ Bunked
                   </button>
                   <button 
                     onClick={() => updateDateStatus(dateString, isCancelled ? null : 'cancelled')} 
                     className={`w-full text-xs py-1 rounded transition-colors ${isCancelled ? 'bg-yellow-600 text-gray-900 font-semibold' : 'bg-gray-600 text-gray-200 hover:bg-yellow-500 hover:text-white'}`}>
                     ğŸ˜´ Cancelled
                   </button>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    );
  };

  /**
   * Custom modal for displaying messages to the user.
   */
  const renderModal = () => {
    if (!modalMessage) return null;
    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div className="bg-gray-800 p-6 rounded-xl shadow-lg w-11/12 md:w-1/3">
          <p className="text-center text-lg font-semibold text-gray-100 mb-4">{modalMessage}</p>
          <button 
            onClick={() => setModalMessage(null)} 
            className="w-full bg-green-500 text-white font-bold py-2 rounded-lg hover:bg-green-600 transition-colors"
          >
            OK
          </button>
        </div>
      </div>
    );
  };

  /**
   * Custom confirmation modal for user actions like deletion.
   */
  const renderConfirmModal = () => {
    if (!confirmModal) return null;
    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div className="bg-gray-800 p-6 rounded-xl shadow-lg w-11/12 md:w-1/3">
          <p className="text-center text-lg font-semibold text-gray-100 mb-4">{confirmModal.message}</p>
          <div className="flex justify-around gap-4">
            <button 
              onClick={confirmModal.onConfirm} 
              className="flex-1 bg-red-600 text-white font-bold py-2 rounded-lg hover:bg-red-700 transition-colors"
            >
              Yes
            </button>
            <button 
              onClick={confirmModal.onCancel} 
              className="flex-1 bg-gray-600 text-gray-200 font-bold py-2 rounded-lg hover:bg-gray-500 transition-colors"
            >
              No
            </button>
          </div>
        </div>
      </div>
    );
  };
  
  if (isLoading) {
    return <div className="text-center p-12 text-lg text-gray-400">Loading...</div>;
  }

  // --- Main JSX Structure ---
  return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&display=swap');
        .font-genz {
          font-family: 'Fredoka', sans-serif;
        }
        .background-brainrott {
          background-image: repeating-linear-gradient(45deg, #1f2937 0, #1f2937 10px, #111827 10px, #111827 20px);
        }
        @keyframes pulse {
          0%, 100% {
            transform: scale(1);
          }
          50% {
            transform: scale(1.05);
          }
        }
        .animate-pulse {
          animation: pulse 1s infinite;
        }
      `}</style>
      <div className="min-h-screen font-genz background-brainrott p-4 sm:p-8">
        {renderModal()}
        {renderConfirmModal()}
        <div className="max-w-6xl mx-auto">
          {/* Header */}
          <header className="text-center mb-8">
            <h1 className="text-3xl font-semibold text-green-400 mb-2">ğŸ“ Bunks Tracker ğŸ¤˜</h1>
            <p className="text-base text-gray-400">Track your class attendance and bunk more. ğŸš€</p>
          </header>

          {/* Setup Section */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            {/* Add Subject Form */}
            <div className="bg-gray-800 p-6 rounded-xl shadow-lg">
              <h2 className="text-xl font-semibold text-gray-100 mb-4">1. Add a New Subject âœ¨</h2>
              <input
                type="text"
                className="w-full p-3 border border-gray-600 rounded-lg mb-4 bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500"
                placeholder="Subject Name (e.g., Physics)"
                value={newSubjectName}
                onChange={(e) => setNewSubjectName(e.target.value)}
              />
              <div className="mb-4">
                <p className="font-semibold text-gray-400 mb-2">Select weekly schedule:</p>
                <div className="flex flex-wrap gap-2">
                  {DAYS_OF_WEEK.map(day => (
                    <button
                      key={day}
                      onClick={() => handleScheduleToggle(day)}
                      className={`px-3 py-1 rounded-full text-sm font-semibold border-2 transition-colors ${
                        newSubjectSchedule.includes(day)
                          ? 'bg-green-500 text-white border-green-600'
                          : 'bg-gray-700 text-gray-300 border-gray-600 hover:bg-green-500 hover:border-green-600 hover:text-white'
                      }`}
                    >
                      {day}
                    </button>
                  ))}
                </div>
              </div>
              <button 
                onClick={addSubject} 
                className="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-600 transition-colors"
              >
                Add Subject ğŸ‰
              </button>
            </div>

            {/* Semester Start Date */}
            <div className="bg-gray-800 p-6 rounded-xl shadow-lg">
              <h2 className="text-xl font-semibold text-gray-100 mb-4">2. Set Semester Start ğŸ—“ï¸</h2>
              <p className="text-gray-400 mb-3">This date is used to calculate total classes.</p>
              <input
                type="date"
                className="w-full p-3 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500"
                value={semesterStartDate}
                onChange={(e) => setSemesterStartDate(e.target.value)}
              />
            </div>
          </div>

          {/* Subjects List */}
          <div className="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
              <h2 className="text-xl font-semibold text-gray-100 mb-4">My Subjects ğŸ‘‡</h2>
              {subjects.length === 0 ? (
                  <p className="text-gray-500">No subjects added yet. Add one above to get started! ğŸ¤·â€â™‚ï¸</p>
              ) : (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      {subjects.map(subject => {
                          const { total, attended, percentage } = calculateAttendance(subject, semesterStartDate);
                          const isBelowGoal = percentage <= ATTENDANCE_GOAL;
                          const isAboveGoal = percentage > ATTENDANCE_GOAL;
                          return (
                              <div 
                                key={subject.id} 
                                className="border border-gray-700 p-5 rounded-lg flex flex-col justify-between transition-shadow hover:shadow-md cursor-pointer bg-gray-700"
                                onClick={() => handleSubjectClick(subject)}
                              >
                                  <div>
                                      <h3 className="text-lg font-semibold text-white">{subject.name}</h3>
                                      <p className="text-sm text-gray-400 mb-3">{subject.schedule.join(', ')}</p>
                                      <div className="mb-3">
                                          <span className={`text-2xl font-semibold ${isBelowGoal && total > 0 ? 'text-red-500' : 'text-green-400'}`}>
                                              {percentage}%
                                          </span>
                                          <p className="text-sm text-gray-400">Attended: {attended} / {total}</p>
                                      </div>
                                      {/* Conditional warning message for attendance below goal */}
                                      {isBelowGoal && (
                                          <div className="mt-2 text-center text-red-500 font-bold animate-pulse text-xl">
                                              you are cooked gang â˜ ï¸
                                          </div>
                                      )}
                                      {/* Conditional warning message for attendance above goal */}
                                      {isAboveGoal && (
                                          <div className="mt-2 text-center text-blue-400 font-bold animate-pulse text-xl">
                                              what the hell gang bunk some classes ğŸ»
                                          </div>
                                      )}
                                  </div>
                                  <div className="flex flex-col gap-2 mt-2">
                                     <button 
                                       onClick={(e) => { e.stopPropagation(); setSelectedSubject(subject); }} 
                                       className="w-full bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors"
                                     >
                                       ğŸ“… Manage Dates
                                     </button>
                                     <button 
                                       onClick={(e) => { e.stopPropagation(); deleteSubject(subject.id); }} 
                                       className="w-full bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors"
                                     >
                                       ğŸ—‘ï¸ Delete
                                     </button>
                                  </div>
                              </div>
                          );
                      })}
                  </div>
              )}
          </div>
          
          {/* Date Manager Section */}
          {renderDateManager()}
        </div>
      </div>
    </>
  );
};

export default App;
